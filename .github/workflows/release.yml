name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

env:
  CARGO_TERM_COLOR: always

# Required for creating releases and uploading assets
permissions:
  contents: write
  issues: write  # Required for failure notifications

jobs:
  # Validate secrets before starting expensive builds
  validate-secrets:
    name: Validate Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Check CARGO_REGISTRY_TOKEN
        run: |
          if [ -z "${{ secrets.CARGO_REGISTRY_TOKEN }}" ]; then
            echo "::error::CARGO_REGISTRY_TOKEN secret is not set!"
            echo "Please add your crates.io token at: https://github.com/getlumos/lumos/settings/secrets/actions"
            echo "Generate token at: https://crates.io/me/tokens (needs publish-update scope)"
            exit 1
          fi
          echo "CARGO_REGISTRY_TOKEN is configured"

  build-binaries:
    name: Build Release Binaries
    needs: validate-secrets
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # lumos CLI binaries
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            package: lumos-cli
            artifact_name: lumos
            asset_name: lumos-linux-x86_64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            package: lumos-cli
            artifact_name: lumos
            asset_name: lumos-linux-x86_64-musl
          - os: macos-latest
            target: x86_64-apple-darwin
            package: lumos-cli
            artifact_name: lumos
            asset_name: lumos-macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            package: lumos-cli
            artifact_name: lumos
            asset_name: lumos-macos-arm64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            package: lumos-cli
            artifact_name: lumos.exe
            asset_name: lumos-windows-x86_64.exe
          # lumos-lsp binaries
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            package: lumos-lsp
            artifact_name: lumos-lsp
            asset_name: lumos-lsp-linux-x86_64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            package: lumos-lsp
            artifact_name: lumos-lsp
            asset_name: lumos-lsp-linux-x86_64-musl
          - os: macos-latest
            target: x86_64-apple-darwin
            package: lumos-lsp
            artifact_name: lumos-lsp
            asset_name: lumos-lsp-macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            package: lumos-lsp
            artifact_name: lumos-lsp
            asset_name: lumos-lsp-macos-arm64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            package: lumos-lsp
            artifact_name: lumos-lsp.exe
            asset_name: lumos-lsp-windows-x86_64.exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install musl tools (Linux musl only)
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }} --package ${{ matrix.package }}

      - name: Strip binary (Unix)
        if: matrix.os != 'windows-latest'
        run: strip target/${{ matrix.target }}/release/${{ matrix.artifact_name }}

      - name: Create tarball (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ${{ matrix.asset_name }}.tar.gz ${{ matrix.artifact_name }}
          mv ${{ matrix.asset_name }}.tar.gz ../../../

      - name: Create zip (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          cd target/${{ matrix.target }}/release
          7z a ${{ matrix.asset_name }}.zip ${{ matrix.artifact_name }}
          move ${{ matrix.asset_name }}.zip ../../../

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.asset_name }}
          path: |
            ${{ matrix.asset_name }}.tar.gz
            ${{ matrix.asset_name }}.zip
          if-no-files-found: ignore

  create-release:
    name: Create GitHub Release
    needs: build-binaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec mv {} release-assets/ \;
          ls -la release-assets/

      - name: Generate SHA256 checksums
        run: |
          cd release-assets
          sha256sum * > SHA256SUMS.txt
          echo "=== SHA256 Checksums ==="
          cat SHA256SUMS.txt

      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          cat << 'EOF' > release_notes.md
          ## LUMOS v${{ steps.get_version.outputs.version }}

          ### Installation

          **Via Cargo (recommended):**
          ```bash
          cargo install lumos-cli
          cargo install lumos-lsp  # Optional: LSP server for editor integration
          ```

          **Via npm (no Rust required):**
          ```bash
          npm install -g @getlumos/cli
          ```

          **Direct download:**
          Download the appropriate binary for your platform from the assets below.

          ### Packages

          | Package | crates.io | Description |
          |---------|-----------|-------------|
          | lumos-core | [![crates.io](https://img.shields.io/crates/v/lumos-core.svg)](https://crates.io/crates/lumos-core) | Core library |
          | lumos-cli | [![crates.io](https://img.shields.io/crates/v/lumos-cli.svg)](https://crates.io/crates/lumos-cli) | CLI tool |
          | lumos-lsp | [![crates.io](https://img.shields.io/crates/v/lumos-lsp.svg)](https://crates.io/crates/lumos-lsp) | Language Server |

          ### Binaries

          | Platform | CLI | LSP Server |
          |----------|-----|------------|
          | Linux x64 | `lumos-linux-x86_64.tar.gz` | `lumos-lsp-linux-x86_64.tar.gz` |
          | Linux x64 (musl) | `lumos-linux-x86_64-musl.tar.gz` | `lumos-lsp-linux-x86_64-musl.tar.gz` |
          | macOS x64 | `lumos-macos-x86_64.tar.gz` | `lumos-lsp-macos-x86_64.tar.gz` |
          | macOS ARM64 | `lumos-macos-arm64.tar.gz` | `lumos-lsp-macos-arm64.tar.gz` |
          | Windows x64 | `lumos-windows-x86_64.zip` | `lumos-lsp-windows-x86_64.zip` |

          ### Verify Downloads

          Download `SHA256SUMS.txt` and verify your binary:

          ```bash
          # Linux/macOS
          sha256sum -c SHA256SUMS.txt --ignore-missing

          # Or verify a single file
          sha256sum lumos-linux-x86_64.tar.gz
          ```

          ---
          **Full Changelog**: https://github.com/getlumos/lumos/compare/v${{ steps.get_version.outputs.version }}...HEAD
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-crates:
    name: Publish to crates.io
    needs: create-release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Publish lumos-core
        run: cargo publish --package lumos-core --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        continue-on-error: false

      - name: Wait for lumos-core to propagate
        run: sleep 30

      - name: Publish lumos-lsp
        run: cargo publish --package lumos-lsp --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        continue-on-error: false

      - name: Wait for lumos-lsp to propagate
        run: sleep 30

      - name: Publish lumos-cli
        run: cargo publish --package lumos-cli --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        continue-on-error: false

  # NOTE: cargo-lumos is not published to crates.io
  # It's installed via: cargo install --git https://github.com/getlumos/lumos cargo-lumos
  # Or built locally from the monorepo

  # NOTE: VSCode extension publishing disabled - extension lives in separate repo
  # See: https://github.com/getlumos/vscode-lumos

  publish-docker:
    name: Publish Docker Image
    needs: create-release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ghcr.io/getlumos/lumos:latest
            ghcr.io/getlumos/lumos:${{ steps.version.outputs.version }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.title=LUMOS
            org.opencontainers.image.description=Type-safe schema language for Solana development
            org.opencontainers.image.version=${{ steps.version.outputs.version }}
            org.opencontainers.image.source=https://github.com/getlumos/lumos
            org.opencontainers.image.licenses=MIT OR Apache-2.0

  notify-failure:
    name: Notify on Release Failure
    needs: [validate-secrets, build-binaries, create-release, publish-crates, publish-docker]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Create failure issue
        uses: actions/github-script@v8
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            const timestamp = new Date().toISOString();

            // Determine which job failed
            const jobs = [
              'validate-secrets',
              'build-binaries',
              'create-release',
              'publish-crates'
            ];

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Release ${tag} failed`,
              labels: ['release-alert', 'priority:critical', 'area:ci'],
              assignees: ['rz1989s'],
              body: `## Release Failure Detected\n\n` +
                    `The release workflow for **${tag}** has failed.\n\n` +
                    `### Details\n\n` +
                    `- **Tag**: ${tag}\n` +
                    `- **Time**: ${timestamp}\n` +
                    `- **Workflow Run**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n` +
                    `### Action Required\n\n` +
                    `1. Check the workflow run logs above for error details\n` +
                    `2. Common failure points:\n` +
                    `   - **validate-secrets**: Missing or invalid CARGO_REGISTRY_TOKEN\n` +
                    `   - **build-binaries**: Compilation errors or missing dependencies\n` +
                    `   - **create-release**: GitHub release creation failed\n` +
                    `   - **publish-crates**: crates.io publishing failed (version conflict, network issues)\n` +
                    `3. Fix the issue and re-tag if necessary\n` +
                    `4. If crates.io publishing failed partially, check which packages were published:\n` +
                    `   - https://crates.io/crates/lumos-core\n` +
                    `   - https://crates.io/crates/lumos-lsp\n` +
                    `   - https://crates.io/crates/lumos-cli\n\n` +
                    `### Recovery Steps\n\n` +
                    `If you need to retry the release:\n` +
                    `\`\`\`bash\n` +
                    `# Delete the failed tag\n` +
                    `git tag -d ${tag}\n` +
                    `git push origin :refs/tags/${tag}\n\n` +
                    `# Fix the issue, then re-tag\n` +
                    `git tag ${tag}\n` +
                    `git push origin ${tag}\n` +
                    `\`\`\`\n\n` +
                    `---\n` +
                    `*This issue was automatically created by the release workflow.*`
            });

      - name: Send success notification
        if: success()
        uses: actions/github-script@v8
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            console.log(`âœ… Release ${tag} completed successfully!`);
            console.log(`Published to:`);
            console.log(`- GitHub: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/releases`);
            console.log(`- crates.io: https://crates.io/crates/lumos-core`);
            console.log(`- crates.io: https://crates.io/crates/lumos-lsp`);
            console.log(`- crates.io: https://crates.io/crates/lumos-cli`);
