#!/bin/bash
# LUMOS Pre-Commit Hook
# Validates staged Rust files (Clippy + rustfmt) and .lumos schema files
# Installation: Run .github/scripts/install-hooks.sh

# Don't exit on first error - we want to run all checks
set +e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Track if any checks failed
ANY_CHECK_FAILED=false

#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# CLIPPY CHECK (Rust linter)
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

STAGED_RS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)

if [ -n "$STAGED_RS_FILES" ]; then
    echo -e "${BLUE}ðŸ” Running Clippy on staged Rust files...${NC}"
    echo ""

    if cargo clippy --all-targets --all-features -- -D warnings 2>&1; then
        echo -e "${GREEN}âœ“${NC} Clippy check passed"
        echo ""
    else
        echo ""
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${RED}âŒ Clippy check failed${NC}"
        echo ""
        echo "Please fix the warnings above and try again."
        echo ""
        echo "To bypass this check (not recommended):"
        echo "  git commit --no-verify"
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        ANY_CHECK_FAILED=true
    fi
fi

#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# RUSTFMT CHECK (Rust formatter)
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

if [ -n "$STAGED_RS_FILES" ]; then
    echo -e "${BLUE}ðŸŽ¨ Checking code formatting with rustfmt...${NC}"
    echo ""

    if cargo fmt --all -- --check 2>&1; then
        echo -e "${GREEN}âœ“${NC} Code formatting check passed"
        echo ""
    else
        echo ""
        echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${YELLOW}âš ï¸  Code formatting check failed${NC}"
        echo ""
        echo "Run this to auto-fix formatting:"
        echo -e "  ${BLUE}cargo fmt --all${NC}"
        echo ""
        echo "Or commit anyway with:"
        echo "  git commit --no-verify"
        echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        ANY_CHECK_FAILED=true
    fi
fi

#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# LUMOS SCHEMA VALIDATION
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# Get list of staged .lumos files
STAGED_LUMOS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.lumos$' || true)

# Check if lumos CLI is installed (only if .lumos files are staged)
if [ -n "$STAGED_LUMOS_FILES" ]; then
    if ! command -v lumos &> /dev/null; then
        echo -e "${RED}âŒ Error: lumos CLI not found${NC}"
        echo ""
        echo "Please install the LUMOS CLI first:"
        echo "  cargo install lumos-cli"
        echo ""
        echo "Or skip this check with:"
        echo "  git commit --no-verify"
        exit 1
    fi

    echo -e "${BLUE}ðŸ” Validating staged .lumos schema files...${NC}"
    echo ""

    # Validation results
    VALIDATION_FAILED=false
    FAILED_FILES=()

    # Validate each staged .lumos file
    while IFS= read -r file; do
        if [ -f "$file" ]; then
            echo -e "${YELLOW}â–¸${NC} Validating: $file"

            # Run lumos validate and capture output
            if lumos validate "$file" &> /dev/null; then
                echo -e "  ${GREEN}âœ“${NC} Valid"
            else
                echo -e "  ${RED}âœ—${NC} Validation failed"
                VALIDATION_FAILED=true
                FAILED_FILES+=("$file")

                # Show the actual error
                echo ""
                echo -e "${RED}Error details:${NC}"
                lumos validate "$file" 2>&1 | sed 's/^/  /'
                echo ""
            fi
        fi
    done <<< "$STAGED_LUMOS_FILES"

    echo ""

    # If any validation failed, mark as failed
    if [ "$VALIDATION_FAILED" = true ]; then
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${RED}âŒ Schema validation failed${NC}"
        echo ""
        echo "The following files have validation errors:"
        for file in "${FAILED_FILES[@]}"; do
            echo -e "  ${RED}âœ—${NC} $file"
        done
        echo ""
        echo "Please fix the errors and try again."
        echo ""
        echo "To bypass this check (not recommended):"
        echo "  git commit --no-verify"
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        ANY_CHECK_FAILED=true
    else
        echo -e "${GREEN}âœ“${NC} All .lumos schemas validated successfully"
        echo ""
    fi
fi

#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# FINAL RESULT
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

if [ "$ANY_CHECK_FAILED" = true ]; then
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}âŒ Pre-commit checks failed${NC}"
    echo ""
    echo "Please fix the issues above and try again."
    echo ""
    echo "To bypass all checks (not recommended):"
    echo "  git commit --no-verify"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    exit 1
fi

# All checks passed
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ… All pre-commit checks passed${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

exit 0
